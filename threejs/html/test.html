<!DOCTYPE html><html><head><title>.: spring physics :.</title>
<style>
body { background: #000; color: #aaa;}
</style>
</head>
<body>
  <!-- TODO -->
<!-- scripts -->
<script type="text/javascript" src="../js/springphysics.js"></script>
<script type="text/javascript" src="../js/three.min.js"></script>
<!-- custom script -->
<script type="text/javascript">
  // Array Remove - By John Resig (MIT Licensed)
  Array.prototype.remove = function(from, to) {
    var rest = this.slice((to || from) + 1 || this.length);
    this.length = from < 0 ? this.length + from : from;
    return this.push.apply(this, rest);
  };

  var spController = SpringPhysicsController.create("../js/");

  /*** VIEW ***/
  var camera, scene, renderer;
  var numX = 50, numY = 35;
  var geometry, material, mesh, light;
  var radius = 25,
    segments = 32,
    rings = 32;
  var mv = 20;
  var collisionLights = [];
  var nodesPosX, nodesPosY,
   velNormX, velNormY, accNormX, accNormY;
  spController.onInitFinished = function(newNodesPosX, newNodesPosY){
    nodesPosX = newNodesPosX;
    nodesPosY = newNodesPosY;
    // Just initialized ...
    velNormX = newNodesPosX;
    velNormY = newNodesPosY;
    accNormX = newNodesPosX;
    accNormY =  newNodesPosY;
    init();
    animate();
  };
  
  spController.onUpdate = function(newNodesPosX, newNodesPosY, collisions
                                    ,pvelNormX, pvelNormY, paccNormX, paccNormY){
    nodesPosX = newNodesPosX;
    nodesPosY = newNodesPosY;
    velNormX = pvelNormX;
    velNormY = pvelNormY;
    accNormX = paccNormX;
    accNormY = paccNormY;
    //if(collisions.length > 0) console.log(collisions.length);
    // for(var i=0; i < collisions.length; i++){
    //     // create a point light
    //     var colLight = new THREE.PointLight(0xffffff);
    //     // set its position
    //     colLight.position.x = collisions[i][0];
    //     colLight.position.y = collisions[i][1];
    //     colLight.position.z = 10;
    //     // add to the scene
    //     scene.add(colLight);
    //     collisionLights.push(colLight);
    // }
    animate();
  };
  spController.init();

  var nodeMeshes = [];
  var velMeshes = [];

  function init() {
      var w = window.innerWidth / 2;
      var h = window.innerHeight / 2;
      camera = new THREE.OrthographicCamera(-w, w, -h, h, 1, 10000 );

      scene = new THREE.Scene();

      geometry = new THREE.SphereGeometry(radius,
                                          segments,
                                          rings);
      material = new THREE.MeshPhongMaterial( { color: 0xCC00CC, specular: 0xFFFFFF } );

      var velMaterial = new THREE.LineBasicMaterial({
        color: 0xFFFF00,
      });

      for (var i=0;i<nodesPosX.length;i++){
        // Nodes
        mesh = new THREE.Mesh( geometry, material );
        mesh.position.x = nodesPosX[i];
        mesh.position.y = nodesPosY[i];
        mesh.position.z = 0;
        nodeMeshes.push(mesh);
        //scene.add( mesh );

        // Velocity vector
        var velGeometry = new THREE.CubeGeometry(5,10,10,10,10,10);
        var velMesh = new THREE.Mesh( velGeometry, velMaterial );
      }
      
      // // create a point light
      // var pointLight = new THREE.PointLight(0x333333);
      // // set its position
      // pointLight.position.x = 0;
      // pointLight.position.y = 0;
      // pointLight.position.z = -5000;
      // // add to the scene
      // scene.add(pointLight);

      // create a point light
      light = new THREE.PointLight(0xaaaaaa, 1.0, -5000);
      // set its position
      light.position.x = 1000;
      light.position.y = 0;
      light.position.z = -5000;
      // add to the scene
      scene.add(light);

            // create a point light
      light = new THREE.PointLight(0xaaaaaa, 0.3, -4000);
      // set its position
      light.position.x = -1000;
      light.position.y = 0;
      light.position.z = -5000;
      // add to the scene
      scene.add(light);

            // create a point light
      light = new THREE.PointLight(0xaaaaaa, 0.2, -3000);
      // set its position
      light.position.x = 0;
      light.position.y = 1000;
      light.position.z = -5000;
      // add to the scene
      scene.add(light);

      // create a point light
      light = new THREE.PointLight(0xaaaaaa, 0.1, -2000);
      // set its position
      light.position.x = 0;
      light.position.y = -1000;
      light.position.z = -5000;
      // add to the scene
      scene.add(light);

      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setSize( window.innerWidth, window.innerHeight );

      document.body.appendChild( renderer.domElement );
  }

  var maxIterations = Infinity;
  var iterations = 0;
  var clock = new THREE.Clock();
  function animate() {
      if(iterations < maxIterations){
        spController.doUpdate();
        iterations += 1;
      }
      // note: three.js includes requestAnimationFrame shim
      //requestAnimationFrame( animate );
      for(var i=0; i < nodeMeshes.length; i++){
        //nodeMeshes[i].position.x = nodesPosX[i];
        //nodeMeshes[i].position.y = nodesPosY[i];
        velLines[i].geometry.vertices[0].x = velNormX[i];
        velLines[i].geometry.vertices[0].y = velNormY[i];
        velLines[i].geometry.vertices[1].x = nodesPosX[i];
        velLines[i].geometry.vertices[1].y = nodesPosY[i];
      }

      // make collision lights darker      
/*      var delta = clock.getDelta();
      for(var i=0; i < collisionLights.length; i++){
        if(collisionLights[i].intensity < 0.1){
          scene.remove(collisionLights[i]);
          collisionLights.remove[i];
          i-=1;
        }else{
          collisionLights[i].intensity -= 2.0*delta;
        }
      }*/
      
      renderer.render( scene, camera );
  }
</script>
</body>
</html>
