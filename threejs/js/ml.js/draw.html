<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="DigitClassifierController.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/jquery-1.7.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/jquery.timers-1.2.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/agility.js" type="text/javascript" charset="utf-8"></script>
    </head>
    <body style="background-color:#000;">
        <script>
            window.onload = function(){     
                
                var labels = "00000111112222233333444445555566666777778888899999"
                var totalArr;
                
                function sizeOf(obj) {
                    var size = 0, key;
                    for (key in obj) {
                        if (obj.hasOwnProperty(key)) size++;
                    }
                    return size;
                };

                // Creates one output neuron per class.
                function createClassDict(labelString){
                    var arr = labelString.split("");
                    var n = arr.length;
                    
                    var chars = [];
                    
                    
                    for(var i=0; i < n; i++){
                        var cls = arr[i];
                        if(chars.indexOf(cls)==-1)
                            chars.push(cls);
                    }
                    
                    return chars;
                }
                
                function createLabelMatrix(classDict, labelString, context){
                    var arr = labelString.split("");
                    var n = arr.length;
                    var m = classDict.length;
                    var sampleArr = new Float64Array(n*m);
                    
                    for(var i=0; i < n; i++){
                        var c = arr[i];
                        var j = classDict.indexOf(c);
                        sampleArr[i*m+j] = 1.0;                        
                    }
                    
                    var sampleMat = context.createMatrix(n,m,sampleArr);
                    return sampleMat;
                }
                              
                function getRMSE(col, callback){
                    col.apply(function(x){return x*x;});
                    col.average(function(avg){
                        if(callback != undefined)
                            callback(Math.sqrt(avg));
                    });                    
                }
                           
                var width=20, height=20;
                
                function pad(num, size) {
                    var s = num+"";
                    while (s.length < size) s = "0" + s;
                    return s;
                }
                
                function loadImagesAsArray(imageSrc, num, callback){
                    totalArr = new Float64Array(20*20*num);
                    var step = num;
                    var canv = document.getElementById('canvas').getContext('2d');
                    
                    var offset = 0;
                    for(var j=1; j < num+1; j++){
                        var imageObj = new Image();     
                        offset = (j-1)*400;
                        imageObj.offset = offset;
                        imageObj.onload = function(){ 
                            canv.drawImage(this, 0, 0);
                            var imageData = canv.getImageData(0,0,20,20);
                            var n = parseInt(imageData.data.length/4);
                            for(var i=0; i < n; i++){
                                totalArr[this.offset+i] = (imageData.data[i*4.0]+imageData.data[i*4.0+1.0]+imageData.data[i*4.0+2.0]) / (3.0 * 255.0);
                            }   
                            step = step-1;        
                            if(step == 0){ 
                                callback(num, 20*20, totalArr);
                            }
                        }
                        imageObj.src = imageSrc+pad(j, 3)+".png";
                    }
                }
                
               function contrastArray(arr, threshold){
                    for(var i=0; i < arr.length; i++){
                        arr[i] < threshold ? arr[i]=0.0 : arr[i]=1.0;
                    }
                    return arr;
               }
                                
               function setPixel(imageData, x, y, r, g, b, a) {
                    var index = (x + y * imageData.width) * 4;
                    imageData.data[index+0] = r;
                    imageData.data[index+1] = g;
                    imageData.data[index+2] = b;
                    imageData.data[index+3] = 255;
               }          
                            
                function paintArray(arr, target, n, width, height){
                     var canv = document.getElementById(target);                     
                     canv.width = 1000;
                     canv.height = Math.ceil(n*20/1000)*20;
                     var c = canv.getContext("2d");
                     
                     var imageData = c.createImageData(canv.width, canv.height);                     
                     var offset = 0;
                     // Array mit variablen zw 0.0 und 1.0
                     // zeilen
                     var yoff = 0;
                     var xoff = 0;
                     for(var i=0; i < n; i++){
                         yoff = Math.floor(i*20/1000)*20;
                         xoff = i*20 % 1000;
                         
                         offset = i*width*height;  
                         for(var j=0; j < width*height; j++){
                             var val = Math.round(arr[offset+j] * 255.0);
                             setPixel(imageData, xoff + (j % width), yoff+ Math.floor(j / height), val, val, val, 0xff);
                         }
                     }                    
                     c.putImageData(imageData, 0, 0);                     
                }
                
                function drawLabels(soll, ist){
                    $("#tableTargets").empty();
                    $("#tableIst").empty();
                    for(var i=0; i < soll.length; i++){                       
                        $("#tableTargets").append('<div style="float:left; height:20px; width:20px;">'+soll[i]+'</div>');
                        if(ist != undefined){
                            if(soll[i] == ist[i])
                                $("#tableIst").append('<div style="float:left; height:20px; width:20px;">'+ist[i]+'</div>');
                            else
                                $("#tableIst").append('<div style="float:left; height:20px; width:20px; color:#f00;">'+ist[i]+'</div>');
                        }
                    }
                }
                
                drawLabels(labels.split(""));
               
                var dcController = DigitClassifierController.create();
                
                dcController.onSetupFinished = function(){
                    // TODO: start pretraining
                    console.log("onSetupFinished");
                    dcController.pretrain(250);
                }                
                dcController.onPretrainUpdate = function(recon, activ, feat){
                    // TODO: paint current reconstruction
                    paintArray(recon, "out", recon.length/400, 20, 20);
                }
                
                dcController.onPretrainFinished = function(recon, activ, feat){
                    // TODO: paint current reconstruction
                    console.log("onPretrainFinished");
                    paintArray(recon, "out", recon.length/400, 20, 20);
                    $("#trainingWait").fadeOut("slow", function(){
                         $("#canvasDiv").fadeIn("slow");
                    });
                    //dcController.train(10);
                }
                
                dcController.onTrainUpdate = function(classes){
                    // TODO: paint current reconstruction
                    drawLabels(labels.split(""), classes);
                }
                
                //localStorage.clear();
                var localItem = localStorage.getItem("digits");
                if(localItem != undefined){
                    console.log(localItem.length);
                    totalArr = JSON.parse(localItem);
                    console.log("items loaded from localstorage");
                    contrastArray(totalArr, 0.3);
                    paintArray(totalArr, "targets", totalArr.length/400, 20, 20);
                    dcController.setup(totalArr, labels);
                }else{
                    console.log("localstorage not available");
                    loadImagesAsArray("img/",50,function(n,m,totalArr){
                        contrastArray(totalArr, 0.3);
                        paintArray(totalArr, "targets", n, 20, 20);
                        dcController.setup(totalArr, labels);
                        localStorage.setItem("digits", JSON.stringify(totalArr));
                        console.log("Saving array in localstorage");
                    });
                }
                    
                
                
                
                // canvas
                
                var drawCanvas = document.getElementById("drawCanvas");
                var drawContext = drawCanvas.getContext("2d");
                var classCanvas = document.getElementById("classCanvas");
                var classContext = classCanvas.getContext("2d");
                
                drawContext.strokeStyle = "#ffffff";
                
                var paint = false;
                var lastX, lastY, x, y;
                
                $('#drawCanvas').mousedown(function(e){
                    lastX = e.pageX - this.offsetLeft;
                    lastY = e.pageY - this.offsetTop;

                    paint = true;
                });
                
                $('#drawCanvas').mousemove(function(e){
                    
                    if(paint){
                        drawContext.beginPath();
                        drawContext.moveTo(lastX, lastY);
                        x = e.pageX - this.offsetLeft;
                        y = e.pageY - this.offsetTop;
                        drawContext.lineTo(x, y);
                        drawContext.lineWidth = 5;
                        drawContext.arc(x, y, 3, 0, 2 * Math.PI, false);
                        // set line color
                        drawContext.strokeStyle = "#ffffff";
                        drawContext.stroke();
                        lastX = x;
                        lastY = y;
                    }
                });
                
                $('#drawCanvas').mouseup(function(e){
                    paint = false;
                    reconContext.scale(0.1, 0.1);
                    reconContext.drawImage(drawCanvas, 0, 0);
                    reconContext.scale(10, 10);
                });
                
                $('#drawCanvas').mouseleave(function(e){
                    paint = false;
                });
                
                var reconCanvas = document.getElementById("reconCanvas");
                var reconContext = reconCanvas.getContext("2d");
                
                // Reads the content of the canvas and transforms it to a Float64Array compatible to Matrix
                function readCanvasContent(){                    
                    var imageData = reconContext.getImageData(0,0,20,20);
                    var n = parseInt(imageData.data.length/4);
                    var arr = new Float64Array(n);
                    for(var i=0; i < n; i++){
                        arr[i] = (imageData.data[i*4.0]+imageData.data[i*4.0+1.0]+imageData.data[i*4.0+2.0]) / (3.0 * 255.0);
                    }         
                    return arr;
                }
                                
                
                
                dcController.onClassifyUpdate = function(recon){
                    console.log("onClassifyUpdate");
                    paintArray(recon, "reconCanvas", 1, 20, 20);
                    
                    classContext.scale(5, 5);
                    classContext.drawImage(reconCanvas, 0, 0);
                    classContext.scale(0.2, 0.2);
                }
                
                dcController.onClassifyFinish = function(recon, label){
                    console.log("onClassifyFinish");
                    paintArray(recon, "reconCanvas", 1, 20, 20);
                    alert("Ich denke es ist: "+label);
                }
                
                window.classify = function(){
                    $("#classDiv").fadeIn("fast");
                    reconContext.scale(0.1, 0.1);
                    reconContext.drawImage(drawCanvas, 0, 0);
                    reconContext.scale(10, 10);
                    
                    var sample = readCanvasContent();
                    dcController.classify(sample);
                }
                
                window.clear = function(){
                    drawCanvas.width = drawCanvas.width;
                    reconCanvas.width = reconCanvas.width;
                    
                }
                
                window.relearn = function(){
                    $("#classDiv").fadeOut("fast");
                    $("#canvasDiv").fadeOut("slow", function(){
                        $("#trainingWait").fadeIn("fast");
                    });
                    contrastArray(totalArr, 0.3);
                    paintArray(totalArr, "targets", totalArr.length/400, 20, 20);
                    dcController.setup(totalArr, labels);
                }
                
                window.addToMemory = function(){
                    reconCanvas.width= reconCanvas.width;
                    reconContext.scale(0.1, 0.1);
                    reconContext.drawImage(drawCanvas, 0, 0);
                    reconContext.scale(10, 10);
                    var newSample = readCanvasContent();
                    console.log("new sample created");
                    var newArr = new Float64Array(totalArr.length + 400);
                    console.log("new array created");
                    newArr.set(totalArr);
                    console.log("copy old content");
                    newArr.set(newSample, totalArr.length );
                    console.log("insert new content");
                    totalArr = newArr;
                    console.log("painting now:");
                    paintArray(totalArr, "targets", totalArr.length/400, 20, 20);       
                    localStorage.setItem("digits", JSON.stringify(totalArr));
                }
            }
            
            
            
        </script>        
        <div style="padding-left:70px; padding-top:20px; color:#fff;">
            <div style="color:#a33; padding-bottom:10px;">Hit F5 to reset <small style="font-size:10px; font-family:sans-serif;">(memory is saved)</small></div>
            <canvas id="canvas" style="display:none;"></canvas>
            <div>Memory:<br>
                <div id="tableTargets" style="display:none; height:20px; width:1060px; border:none; background:#000; color:#fff;"></div>
                <canvas style ="border: 1px solid black;" id="targets" height="20" width="1060"></canvas>
            </div>
            <div>Reconstructions: <br>           
                <canvas style ="border: 1px solid black;" id="out" height="20" width="1060"></canvas>
            </div>
            <div id="tableIst" style="height:20px; width:1060px; border:none; background:#000; color:#fff;"></div>
            <div id="trainingWait" style="font-size:30px; color:#fff; margin-left:300px;">Learning ... please wait!</div>
            <div id="canvasDiv" style="display:none;">
                <div style="color:#fff; padding-bottom:20px;">If you draw a number, I will try to find something similar in my memory:</div>
                <canvas id="drawCanvas" style="float:left; border:1px white solid;" width="200" height="200"></canvas>                
                <canvas id="reconCanvas" style="display:none; border:1px white solid;" width="20" height="20"></canvas>
                <div id="classDiv" style="display:none; float:left; margin-left:50px;">
                    <div style="color:#fff; padding-bottom:5px;">Reconstructed from my memory: </div><br>
                    <canvas id="classCanvas" style="float:left; border:1px white solid;margin-bottom:50px;" width="100" height="100"></canvas>
                </div>
                <div style="clear:both; margin-top:30px;">
                    <div style="float:left; border:solid 1px #fff; color:#fff; background:#000; margin:5px; margin-left:0px;"><button onclick="window.classify();" style="border:none; color:#fff; background:#000;">Classify</button></div>
                    <div style="float:left; border:solid 1px #fff; color:#fff; background:#000; margin:5px; margin-left:0px;"><button onclick="window.clear();" style="border:none; color:#fff; background:#000;">Clear</button></div>
                    <div style="float:left; border:solid 1px #fff; color:#fff; background:#000; margin:5px; margin-left:0px;"><button onclick="window.addToMemory();" style="border:none; color:#fff; background:#000;">Add to memory</button></div>
                    <div style="float:left; border:solid 1px #fff; color:#fff; background:#000; margin:5px; margin-left:0px;"><button onclick="window.relearn();" style="border:none; color:#fff; background:#000;">Relearn</button></div>
                </div>
                <div id="features" style="display:none">
                    Features: <canvas id="featureCanvas" height="20" width="1060"/>
                </div>
            </div>
        </div>
    </body>
</html>
