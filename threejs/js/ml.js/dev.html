<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="DigitClassifierController.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/jquery-1.7.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/jquery.timers-1.2.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/agility.js" type="text/javascript" charset="utf-8"></script>
    </head>
    <body style="background-color:#000;">
        <script>
            window.onload = function(){     
                
                var labels = "00000111112222233333444445555566666777778888899999"
                
                function sizeOf(obj) {
                    var size = 0, key;
                    for (key in obj) {
                        if (obj.hasOwnProperty(key)) size++;
                    }
                    return size;
                };

                // Creates one output neuron per class.
                function createClassDict(labelString){
                    var arr = labelString.split("");
                    var n = arr.length;
                    
                    var chars = [];
                    
                    
                    for(var i=0; i < n; i++){
                        var cls = arr[i];
                        if(chars.indexOf(cls)==-1)
                            chars.push(cls);
                    }
                    
                    return chars;
                }
                
                function createLabelMatrix(classDict, labelString, context){
                    var arr = labelString.split("");
                    var n = arr.length;
                    var m = classDict.length;
                    var sampleArr = new Float64Array(n*m);
                    
                    for(var i=0; i < n; i++){
                        var c = arr[i];
                        var j = classDict.indexOf(c);
                        sampleArr[i*m+j] = 1.0;                        
                    }
                    
                    var sampleMat = context.createMatrix(n,m,sampleArr);
                    return sampleMat;
                }
                              
                function getRMSE(col, callback){
                    col.apply(function(x){return x*x;});
                    col.average(function(avg){
                        if(callback != undefined)
                            callback(Math.sqrt(avg));
                    });                    
                }
                           
                var width=20, height=20;
                
                function pad(num, size) {
                    var s = num+"";
                    while (s.length < size) s = "0" + s;
                    return s;
                }
                
                function loadImagesAsArray(imageSrc, num, callback){
                    var totalArr = new Float64Array(20*20*num);
                    var step = num;
                    var canv = document.getElementById('canvas').getContext('2d');
                    
                    var offset = 0;
                    for(var j=1; j < num+1; j++){
                        var imageObj = new Image();     
                        offset = (j-1)*400;
                        imageObj.offset = offset;
                        imageObj.onload = function(){ 
                            canv.drawImage(this, 0, 0);
                            var imageData = canv.getImageData(0,0,20,20);
                            var n = parseInt(imageData.data.length/4);
                            for(var i=0; i < n; i++){
                                totalArr[this.offset+i] = (imageData.data[i*4.0]+imageData.data[i*4.0+1.0]+imageData.data[i*4.0+2.0]) / (3.0 * 255.0);
                            }   
                            step = step-1;        
                            if(step == 0){ 
                                callback(num, 20*20, totalArr);
                            }
                        }
                        imageObj.src = imageSrc+pad(j, 3)+".png";
                    }
                }
                
               function contrastArray(arr, threshold){
                    for(var i=0; i < arr.length; i++){
                        arr[i] < threshold ? arr[i]=0.0 : arr[i]=1.0;
                    }
                    return arr;
               }
                                
               function setPixel(imageData, x, y, r, g, b, a) {
                    var index = (x + y * imageData.width) * 4;
                    imageData.data[index+0] = r;
                    imageData.data[index+1] = g;
                    imageData.data[index+2] = b;
                    imageData.data[index+3] = 255;
               }          
                            
                function paintArray(arr, target, n, width, height){
                     var c = document.getElementById(target).getContext("2d");
                     var imageData = c.createImageData(width*n, height);                     
                     var offset = 0;
                     // Array mit variablen zw 0.0 und 1.0
                     for(var i=0; i < n; i++){
                         offset = i*width*height;  
                         for(var j=0; j < width*height; j++){
                             var val = Math.round(arr[offset+j] * 255.0);
                             setPixel(imageData, offset/height + (j % width), Math.floor(j / height), val, val, val, 0xff);
                         }
                     }                    
                     c.putImageData(imageData, 0, 0);                     
                }
                
                function drawLabels(soll, ist){
                    $("#tableTargets").empty();
                    $("#tableIst").empty();
                    for(var i=0; i < soll.length; i++){                       
                        $("#tableTargets").append('<div style="float:left; height:20px; width:20px;">'+soll[i]+'</div>');
                        if(ist != undefined){
                            if(soll[i] == ist[i])
                                $("#tableIst").append('<div style="float:left; height:20px; width:20px;">'+ist[i]+'</div>');
                            else
                                $("#tableIst").append('<div style="float:left; height:20px; width:20px; color:#f00;">'+ist[i]+'</div>');
                        }
                    }
                }
                
                drawLabels(labels.split(""));
               
                var dcController = DigitClassifierController.create();
                dcController.onSetupFinished = function(){
                    // TODO: start pretraining
                    console.log("onSetupFinished");
                    dcController.pretrain(200);
                }                
                dcController.onPretrainUpdate = function(recon, activ, feat){
                    // TODO: paint current reconstruction
                    paintArray(recon, "out", recon.length/400, 20, 20);
                }
                
                dcController.onPretrainFinished = function(recon, activ, feat){
                    // TODO: paint current reconstruction
                    console.log("onPretrainFinished");
                    paintArray(recon, "out", recon.length/400, 20, 20);
                    dcController.train(20000);
                }
                
                dcController.onTrainUpdate = function(classes){
                    // TODO: paint current reconstruction
                    drawLabels(labels.split(""), classes);
                }
                
                loadImagesAsArray("img/",50,function(n,m,totalArr){
                    contrastArray(totalArr, 0.3);
                    paintArray(totalArr, "targets", n, 20, 20);
                    dcController.setup(totalArr, labels);
                });
            }
            
        </script>
        <div style="padding:20px;">
            <canvas id="canvas" style="display:none;"></canvas>
            <center><div id="tableTargets" style="display:none; height:20px; width:1060px; border:none; background:#000; color:#fff;"></div></center>
            <center><canvas style ="border: 1px solid black;" id="targets" height="20" width="1060"></canvas></center>
            <center><canvas style ="border: 1px solid black;" id="out" height="20" width="1060"></canvas></center>
            <center><div id="tableIst" style="height:20px; width:1060px; border:none; background:#000; color:#fff;"></div></center>
        </div>
    </body>
</html>
